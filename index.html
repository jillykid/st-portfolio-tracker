<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ST Portfolio - Delm√•l & Aktiviteter</title>
  <style>
    /* Keep your existing CSS styles */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè• ST Portfolio</h1>
      <p class="subtitle">Sp√•ra dina delm√•l och dokumenterade aktiviteter</p>
    </header>

    <div class="sync-status">
      üîÑ Ansluter till Google Sheets...
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('overview')">üìä √ñversikt</div>
      <div class="tab" onclick="switchTab('activities')">üìã Aktiviteter</div>
      <div class="tab" onclick="switchTab('delmal')">üéØ Delm√•l</div>
    </div>

    <div id="overview" class="tab-content active">
      <div class="dashboard">
        <div class="main-content">
          <h2 style="margin-bottom: 20px; color: #4a5568;">Senaste Aktiviteter</h2>
          <div class="activity-list" id="overview-activities"></div>
        </div>
        <div class="sidebar">
          <h3 style="margin-bottom: 20px; color: #4a5568;">Delm√•l Progress</h3>
          <div id="overview-sidebar-content"></div>
        </div>
      </div>
    </div>

    <div id="activities" class="tab-content">
      <div class="main-content">
        <div class="activity-list" id="activityList"></div>
      </div>
    </div>

    <div id="delmal" class="tab-content">
      <div class="main-content">
        <h2 style="margin-bottom: 20px; color: #4a5568;">Alla Delm√•l</h2>
        <div id="delmalList"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbw20mqd5nIjXCDogGeRIj_3Gmx5FdSO6lh2EGzY3UhzlH8qCJRoji18MdlAOsd067GYjg/exec';

    async function fetchFromAPI(action) {
      try {
        const response = await fetch(`${API_BASE_URL}?action=${action}`);
        return await response.json();
      } catch (error) {
        console.error('API error:', error);
        return null;
      }
    }

    async function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'delmal') await loadDelmalTab();
    }

    async function loadDelmalTab() {
      const container = document.getElementById('delmalList');
      container.innerHTML = '<div style="text-align:center; padding:20px;">Laddar delm√•l...</div>';

      const data = await fetchFromAPI('getDelmalProgress');
      container.innerHTML = '';

      if (!data || data.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:40px; color:#718096;">Kunde inte ladda delm√•l data.</div>';
        return;
      }

      data.forEach(delmal => {
        const el = createDelmalElement(delmal);
        container.appendChild(el);
      });
    }

    function createDelmalElement(delmal) {
      const div = document.createElement('div');

      const progress = delmal.progress ?? 0;
      const validatedStatus = delmal.validated_status || "Ej genomf√∂rt";
      const statusColor = {
        "Avklarat": "#48bb78",
        "Delvis genomf√∂rt": "#f6ad55",
        "Ej genomf√∂rt": "#f56565"
      };

      const badgeColor = statusColor[validatedStatus] || "#ccc";

      div.className = `delmal-item ${validatedStatus === 'Avklarat' ? 'completed' : ''}`;
      div.innerHTML = `
        <div class="delmal-code">${delmal.code}</div>
        <div class="delmal-title">${delmal.title}</div>
        <div class="delmal-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
          </div>
          <div class="progress-text" style="margin-top: 8px;">
            ${progress}% ‚Ä¢ 
            <span style="background: ${badgeColor}; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.8rem;">
              ${validatedStatus}
            </span>
          </div>
        </div>
      `;
      return div;
    }

    document.addEventListener('DOMContentLoaded', async function () {
      const syncStatus = document.querySelector('.sync-status');
      syncStatus.innerHTML = 'üîÑ Ansluter till Google Sheets...';

      try {
        await loadDelmalTab();
        const now = new Date();
        const timeString = now.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        syncStatus.innerHTML = `‚úÖ Synkroniserad med Google Sheets ‚Ä¢ Senast uppdaterad: Idag ${timeString}`;
      } catch (err) {
        syncStatus.innerHTML = '‚ùå Fel vid anslutning till Google Sheets';
      }
    });
  </script>
</body>
</html>
